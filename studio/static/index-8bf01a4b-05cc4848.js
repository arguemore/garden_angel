import{r as u,j as i,aD as oe,az as Y,b5 as ae,aE as ie,cB as ce,Z as H,a0 as le,a4 as ue,aQ as de,b as _,O as me,cC as pe,ab as fe,cD as he,cE as ye,cF as ge,aU as Te,bj as Ie,a5 as V,e as w,ax as k,S as Le,bP as ve,T as E,aq as x,aA as be,F as Se,g as Pe,cG as Re,C as N,Q as _e,o as Ce,Y as Ee,bd as A,cH as je,cI as xe,U as De,cJ as Oe,cK as Fe,m as q,k as we,cL as Ae,cn as Me,co as $e,l as ke,cM as Ne,cN as qe,bT as B,bV as Be,cO as We,bK as Ue,be as Ye,h as He,cP as Ve,cQ as Ge,cR as Ke,bL as ze}from"./desk-592bd320-5caa45cd.js";import{useDeskTool as Qe,useDeskToolSetting as W,Delay as Xe}from"./index-63f13ccc-f418aabe.js";import{P as Je}from"./PaneItem-7d791ca0-7361ba34.js";import"./_commonjsHelpers-042e6b4d.js";import"./index-7be5955f.js";const U=100,M=2e3,G={by:[{field:"_updatedAt",direction:"desc"}]},Ze={};function et(e,s){return e._id?V(e._id):"item-".concat(s)}function tt(e){return Oe(e).map(s=>({...s.draft||s.published,hasPublished:!!s.published,hasDraft:!!s.draft}))}const nt=/\b_type\s*==\s*(['"].*?['"]|\$.*?(?:\s|$))|\B(['"].*?['"]|\$.*?(?:\s|$))\s*==\s*_type\b/;function st(e){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const t=e.match(nt);if(!t)return null;const n=(t[1]||t[2]).trim().replace(/^["']|["']$/g,"");if(n[0]==="$"){const r=n.slice(1),c=s[r];return typeof c=="string"?c:null}return n}function rt(e){return/^_type\s*==\s*['"$]\w+['"]?\s*$/.test(e.trim())}function ot(e){return e.map(s=>[at(s),(s.direction||"").toLowerCase()].map(t=>t.trim()).filter(Boolean).join(" ")).join(",")}function at(e){return e.mapWith?"".concat(e.mapWith,"(").concat(e.field,")"):e.field}function it(e,s){const t=e.by.map(n=>{if(n.mapWith)return n;const r=ct(s,n.field);return r?ut(r,"datetime")?{...n,mapWith:"dateTime"}:r.jsonType==="string"?{...n,mapWith:"lower"}:n:n});return t.every((n,r)=>n===e.by[r])?e:{...e,by:t}}function ct(e,s){const t=fe(s);let n=e;for(const r of t){if(!n)return;if(typeof r=="string"){n=lt(n,r);continue}if(!(he(r)||ye(r))||n.jsonType!=="array")return;const[o,a]=n.of||[];if(a||!o)return;if(!ge(o)){n=o;continue}const[m,p]=o.to||[];if(p||!m)return;n=m}return n}function lt(e,s){if(!("fields"in e))return;const t=e.fields.find(n=>n.name===s);return t?t.type:void 0}function ut(e,s){let t=e.type;for(;t;){if(t.name===s||!t.type&&t.jsonType===s)return!0;t=t.type}return!1}function dt(e){const{childItemId:s,error:t,filterIsSimpleTypeContraint:n,fullList:r,isActive:c,isLoading:o,items:a,layout:m,onListChange:p,onRetry:l,showIcons:y}=e,b=H(),{collapsed:L}=Te(),{collapsed:v,index:g}=Ie(),[S,P]=u.useState(!1);u.useEffect(()=>{if(v)return;const d=setTimeout(()=>{P(!0)},0);return()=>{clearTimeout(d)}},[v]);const T=u.useCallback(d=>{const I=V(d._id),f=s===I;return i(Je,{icon:y===!1?!1:void 0,id:I,pressed:!c&&f,selected:c&&f,layout:m,schemaType:b.get(d._type),value:d})},[s,c,m,b,y]),h=u.useMemo(()=>{if(!S)return null;if(t)return i(w,{align:"center",direction:"column",height:"fill",justify:"center",children:i(k,{width:1,children:_(Le,{paddingX:4,paddingY:5,space:4,children:[i(ve,{as:"h3",children:"Could not fetch list items"}),_(E,{as:"p",children:["Error: ",i("code",{children:t.message})]}),l&&i(x,{children:i(Y,{icon:be,onClick:l,text:"Retry",tone:"primary"})})]})})});if(a===null)return i(w,{align:"center",direction:"column",height:"fill",justify:"center",children:i(Xe,{ms:300,children:_(Se,{children:[i(Pe,{muted:!0}),i(x,{marginTop:3,children:i(E,{align:"center",muted:!0,size:1,children:"Loading documents…"})})]})})});if(!o&&a.length===0)return i(w,{align:"center",direction:"column",height:"fill",justify:"center",children:i(k,{width:1,children:i(x,{paddingX:4,paddingY:5,children:i(E,{align:"center",muted:!0,size:2,children:n?"No documents of this type":"No matching documents"})})})});const d=r&&a.length===M;return _(x,{padding:2,children:[a.length>0&&i(Re,{gap:1,getItemKey:et,items:a,renderItem:T,onChange:p},"".concat(g,"-").concat(v)),o&&i(N,{borderTop:!0,marginTop:1,paddingX:3,paddingY:4,children:i(E,{align:"center",muted:!0,size:1,children:"Loading…"})}),d&&i(N,{marginTop:1,paddingX:3,paddingY:4,radius:2,tone:"transparent",children:_(E,{align:"center",muted:!0,size:1,children:["Displaying a maximum of ",M," documents"]})})]})},[t,n,r,p,o,a,l,T,S,v,g]);return i(_e,{overflow:L?void 0:"auto",children:h})}const K=u.memo(e=>{let{index:s,initialValueTemplates:t=[],menuItems:n=[],menuItemGroups:r=[],setLayout:c,setSortOrder:o,title:a}=e;const{features:m}=Qe(),p=u.useMemo(()=>({setLayout:l=>{let{layout:y}=l;c(y)},setSortOrder:l=>{o(l)}}),[c,o]);return i(oe,{backButton:m.backButton&&s>0&&i(Y,{as:ae,"data-as":"a",icon:ie,mode:"bleed"}),title:a,actions:i(ce,{initialValueTemplateItems:t,actionHandlers:p,menuItemGroups:r,menuItems:n})})});K.displayName="DocumentListPaneHeader";const mt={result:null,error:!1},pt=e=>({result:{documents:e},loading:!1,error:!1}),ft=e=>({result:null,loading:!1,error:e}),ht=function(e){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const t=new Fe,n=t.next.bind(t);return e.pipe(q(o=>({client:o.client,query:o.query,params:o.params})),we(Ae),Me(1),$e()).pipe(ke(o=>{const a=Ne(o.client,o.query,o.params,s).pipe(q(pt),qe());return B(A({loading:!0}).pipe(Be(400),We(a)),a)})).pipe(Ue(mt),Ye((o,a)=>He(A(ft(o)),B(Ve(window,"online"),t).pipe(Ge(1),Ke(a)))),ze((o,a)=>({...o,...a,onRetry:n})))};function yt(e){var s;const{apiVersion:t,filter:n,params:r,sortOrder:c}=e,o=Ce(Ee),[a,m]=u.useState(!1),p=u.useRef(a),[l,y]=u.useState(null),b=(l==null?void 0:l.error)||null,L=(l==null?void 0:l.loading)||l===null,v=l==null?void 0:l.onRetry,g=(s=l==null?void 0:l.result)==null?void 0:s.documents,S=u.useMemo(()=>g?tt(g):null,[g]),P=u.useMemo(()=>{const h=c==null?void 0:c.extendedProjection,d=["_id","_type"],I=d.join(","),f=(c==null?void 0:c.by)||[],C=a?M:U,R=f.length>0?f:G.by,j=ot(R);if(h){const D=d.concat(h).join(",");return["*[".concat(n,"] {").concat(D,"}"),"order(".concat(j,") [0...").concat(C,"]"),"{".concat(I,"}")].join("|")}return"*[".concat(n,"]|order(").concat(j,")[0...").concat(C,"]{").concat(I,"}")},[n,a,c]),T=u.useCallback(h=>{let{toIndex:d}=h;L||p.current||d>=U/2&&(m(!0),p.current=!0)},[L]);return u.useEffect(()=>{const h=a?f=>Boolean(f.result):()=>!0;y(f=>f?{...f,loading:!0}:null);const I=ht(A({client:o,query:P,params:r}),{apiVersion:t,tag:"desk.document-list"}).pipe(je(h)).subscribe(y);return()=>I.unsubscribe()},[t,o,a,P,r]),u.useEffect(()=>{y(null),m(!1),p.current=!1},[n,r,c,t]),{error:b,fullList:a,handleListChange:T,isLoading:L,items:S,onRetry:v}}const $=[];function gt(e){const s=u.useRef(e);return xe(s.current,e)||(s.current=e),s.current}const Tt=e=>{const{menuItems:s,sortOrder:t,layout:n}=e;return s==null?void 0:s.map(r=>{var c,o,a,m,p,l;return(c=r.params)!=null&&c.layout?{...r,selected:n===((o=r.params)==null?void 0:o.layout)}:(a=r==null?void 0:r.params)!=null&&a.extendedProjection?{...r,selected:(t==null?void 0:t.extendedProjection)===((m=r==null?void 0:r.params)==null?void 0:m.extendedProjection)}:(p=r==null?void 0:r.params)!=null&&p.by?{...r,selected:De(t==null?void 0:t.by,((l=r==null?void 0:r.params)==null?void 0:l.by)||$)}:{...r,selected:!1}})},Pt=u.memo(function(s){const{childItemId:t,index:n,isActive:r,isSelected:c,pane:o,paneKey:a}=s,m=H(),{name:p}=le(),{defaultLayout:l="default",displayOptions:y,initialValueTemplates:b=$,menuItems:L,menuItemGroups:v,options:g,title:S}=o,{apiVersion:P,defaultOrdering:T=$,filter:h}=g,d=gt(g.params||Ze),I=o.source,f=u.useMemo(()=>st(h,d),[h,d]),C=(y==null?void 0:y.showIcons)!==!1,[R,j]=W(f,"layout",l),D=u.useMemo(()=>(T==null?void 0:T.length)>0?{by:T}:G,[T]),[O,z]=W(f,"sortOrder",D),Q=f&&O?it(O,m.get(f)):O,F=ue(Q),X=rt(h),{error:J,fullList:Z,handleListChange:ee,isLoading:te,items:ne,onRetry:se}=yt({filter:h,params:d,sortOrder:F,apiVersion:P}),re=u.useMemo(()=>Tt({menuItems:L,sortOrder:F,layout:R}),[R,L,F]);return i(de,{name:I||p,children:_(me,{currentMaxWidth:350,id:a,maxWidth:640,minWidth:320,selected:c,children:[pe,i(K,{index:n,initialValueTemplates:b,menuItems:re,menuItemGroups:v,setLayout:j,setSortOrder:z,title:S}),i(dt,{childItemId:t,error:J,filterIsSimpleTypeContraint:X,fullList:Z,isActive:r,isLoading:te,items:ne,layout:R,onListChange:ee,onRetry:se,showIcons:C})]})})});export{Pt as default};
